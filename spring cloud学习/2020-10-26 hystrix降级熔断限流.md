# Hystrix

使用了hystrix和feign

main方法添加注解

使用在服务端

```
@EnableFeignClients
@EnableHystrix

```

```xml
<!--hystrix 服务降级、熔断、限流-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
</dependency>
```

```yml
#使用了feign和hystrix后需要进行设置才能启动hystrix进行降级/熔断/限流
feign:
  hystrix:
    enabled: true
```

## 1.降级

降级使用方法

> **==优先级==**判断
>
> 方法4<(方法2+方法1)<方法3

### 1.@DefaultProperties

```java
@DefaultProperties(defaultFallback = "payment_Global_FallbackMethod")//配置本方法的全局默认降级策略（本类中的方法）
```

### 2.@HystrixCommand

 没有配置则默认找全局的fallback

### 3.单独fallback

```java
@HystrixCommand(fallbackMethod = "paymentTimeOutFallbackMethod",commandProperties = {//降级使用的方法（本类中的方法）
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "3000")//超时后降级
})//降级策略--兜底
```

### 4.实现接口，在@FeignClient

```java
//在@FeignClient 里面的fallback全局降级方法优先级低于controller处使用的@HystrixCommand注解
@FeignClient(value = "CLOUD-PROVIDER-HYSTRIX-PAYMENT",fallback = PaymentHystrixServiceFallback.class)//配置后继承本接口可以实现同一的降级处理与解耦
```

```java
@Component//需要注入Spring容器
public class PaymentHystrixServiceFallback implements PaymentHystrixService {
    @Override
    public String paymentInfo_OK(Integer id) {
        return "PaymentHystrixService 进行fallback降级处理 ： paymentInfo_OK /(ㄒoㄒ)/~~";
    }

    @Override
    public String paymentInfo_TimeOut(Integer id) {
        return "PaymentHystrixService 进行fallback降级处理 ：paymentInfo_TimeOut /(ㄒoㄒ)/~~";
    }
}
```

## 2.熔断

main方法

```java
@EnableCircuitBreaker//使用断路器 这里是为了启动Hystrix下HystrixCommand等系列进行服务降级
```

熔断一般配置在服务端的service实现层

```java
//服务熔断
@HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback",
        commandProperties = {@HystrixProperty(name = "circuitBreaker.enabled", value = "true"),  //是否开启断路器
                @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),   //请求次数
                @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "10000"),  //时间范围
                @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "60"), //失败率达到多少后跳闸
        })
```

当触发后hystrix阻止方法进入降级方法，之后会慢慢恢复

## 3.仪表盘

HystrixDashboardMain9001

```xml

    <dependencies>

        <!-- hystrix仪表盘 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix-dashboard</artifactId>
        </dependency>

        <!-- 图像处理图形化展示和坐标监控 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>


        <dependency>
            <groupId>com.atguigu.springcloud</groupId>
            <artifactId>cloud-api-commons</artifactId>
        </dependency>
    </dependencies>
```



```java
@SpringBootApplication
@EnableHystrixDashboard
public class HystrixDashboardMain9001 {

    public static void main(String[] args) {
        SpringApplication.run(HystrixDashboardMain9001.class, args);
    }
}
```

```yml
server:
  port: 9001
```

能被监控需要设置

main

```java
@SpringBootApplication
@EnableEurekaClient
@EnableCircuitBreaker//使用断路器 这里是为了启动Hystrix下HystrixCommand等系列进行服务降级
public class PaymentHystrixMain8001 {
    public static void main(String[] args) {
        SpringApplication.run(PaymentHystrixMain8001.class, args);
    }

    //大佬截取的源码

    /**
     * 为服务监控而配置，与服务容错本身无关==>springboot升级后问题
     * 添加的原因是应为spring-cloud升级后
     * ServletRegistrationBean由于springboot的默认路径不是‘hystrix.stream’-->会报404
     *
     * @return
     */
    @Bean
    public ServletRegistrationBean getServlet() {
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings("/hystrix.stream");
        registrationBean.setName("HystrixMetricsStreamServlet");
        return registrationBean;
    }

}
```