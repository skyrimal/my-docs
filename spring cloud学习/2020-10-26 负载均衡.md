# 1.Ribbin

==**eureka**==自带ribbin，所以不用导入仓库

@EnableEurekaClient或配置满足Eureka时启动

ribbin规则全部来自对IRule的实现

![img](../%E5%9B%BE%E7%89%87/B2C46CC8-EC7F-4F0A-8AC6-2FF3B253C794.png) 

八个基本ribbin

![image-20201026203213058](../%E5%9B%BE%E7%89%87/image-202adad213058.png)

## 替换ribbin

###1.main下添加注解

```java
@RibbonClient(name = "CLOUD-PAYMENT-SERVICE",//服务名
              configuration = MyselfRule.class)//新规则
```

### 2.新方法要放到不被启动时默认扫描到，放在main所在包外

> ==**不然会新规则默认全局替换**==

![image-20201026203756967](../%E5%9B%BE%E7%89%87/image-20201026203756967.png)

```java
//基础替换
@Configuration//官方要求不能在启动类同级与以下，否则替换全局规则
public class MyselfRule {
    @Bean
    public IRule myRule(){
        return new RandomRule();//使用随机Rule进行访问服务下应用
    }
}
```

### 3.模仿轮询

![image-20201026204208750](../%E5%9B%BE%E7%89%87/image-20201026204208750.png)

```java
public interface LoadBalancer {
    ServiceInstance instance(List<ServiceInstance> serviceInstances);
}
```

```java
@Component
public class MyLoadBalancer implements LoadBalancer{
    private AtomicInteger atomicInteger = new AtomicInteger(0);

    public final int getAndIncrement(){
        int current;
        int next;

        //do while自旋锁
        do{
            current = this.atomicInteger.get();
            next = current>=2147483647?0:current+1;
        }while (!this.atomicInteger.compareAndSet(current,next));
        System.out.println("*****next:"+next);
        return next;
    }
    @Override
    public ServiceInstance instance(List<ServiceInstance> serviceInstances) {
        int index = getAndIncrement()%serviceInstances.size();
        return serviceInstances.get(index);
    }
}
```

```java
@GetMapping("/consumer/payment/lb")
public String getPaymentLB(){
    List<ServiceInstance> serviceInstances = discoveryClient.getInstances(PAYMENT_SERVICE_NAME);
    if(serviceInstances==null||serviceInstances.size()<=0){
        return null;
    }
    ServiceInstance serviceInstance = loadBalancer.instance(serviceInstances);
    URI uri = serviceInstance.getUri();
    return restTemplate.getForObject(uri+"/payment/lb",String.class);
}
```





# 2.openfeign

> 本质还是ribbin

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

使用在消费端

1.main添加启动注解

![image-20201026204537462](../%E5%9B%BE%E7%89%87/image-20201026204537462.png)

2.创建service层接口，接口使用FeignClient注解指定服务名，下方方法对应服务端controller

![image-20201026204524107](../%E5%9B%BE%E7%89%87/image-20201026204524107.png)

3.超时设置

```yml
#ribon属性设置
ribbon:
  #寻找服务方接口最长时间  与服务建立连接最长等待时间
  ReadTimeout: 5000
  #建立连接后等待资源反馈最长等待时间
  ConnectTimeout: 5000
```

