# 拦截为登录操作进行插入查询数据库

当没有客户端连接服务时，org.jeecg.config.mybatis.MybatisInterceptor implements Interceptor会对数据库session有参数插入的insert、update操作进行拦截。

>补充，mybatis的insert方法调用的是自己的update方法

__进行判断时的代码__进行JwtUtil单点登录判断

```java
if (SqlCommandType.INSERT == sqlCommandType) {
   LoginUser sysUser = JwtUtil.getLoginUser();
   Field[] fields = oConvertUtils.getAllFields(parameter);
   for (Field field : fields) {
      log.debug("------field.name------" + field.getName());
      try {
         if ("createBy".equals(field.getName())) {
            field.setAccessible(true);
            Object local_createBy = field.get(parameter);
            field.setAccessible(false);
            if (local_createBy == null || local_createBy.equals("")) {
               if (sysUser != null) {
                  // 登录人账号
                  field.setAccessible(true);
                  field.set(parameter, sysUser.getUsername());
                  field.setAccessible(false);
               }
            }
         }
         // 注入创建时间
         if ("createTime".equals(field.getName())) {
            field.setAccessible(true);
            Object local_createDate = field.get(parameter);
            field.setAccessible(false);
            if (local_createDate == null || local_createDate.equals("")) {
               field.setAccessible(true);
               field.set(parameter, new Date());
               field.setAccessible(false);
            }
         }
         //注入部门编码
         if ("sysOrgCode".equals(field.getName())) {
            field.setAccessible(true);
            Object local_sysOrgCode = field.get(parameter);
            field.setAccessible(false);
            if (local_sysOrgCode == null || local_sysOrgCode.equals("")) {
               // 获取登录用户信息
               if (sysUser != null) {
                  field.setAccessible(true);
                  field.set(parameter, sysUser.getOrgCode());
                  field.setAccessible(false);
               }
            }
         }
      } catch (Exception e) {
      }
   }
}
if (SqlCommandType.UPDATE == sqlCommandType) {
   LoginUser sysUser = JwtUtil.getLoginUser();
   Field[] fields = null;
   if (parameter instanceof ParamMap) {
      ParamMap<?> p = (ParamMap<?>) parameter;
      //update-begin-author:scott date:20190729 for:批量更新报错issues/IZA3Q--
      if (p.containsKey("et")) {
         parameter = p.get("et");
      } else {
         parameter = p.get("param1");
      }
      //update-end-author:scott date:20190729 for:批量更新报错issues/IZA3Q-

      //update-begin-author:scott date:20190729 for:更新指定字段时报错 issues/#516-
      if (parameter == null) {
         return invocation.proceed();
      }
      //update-end-author:scott date:20190729 for:更新指定字段时报错 issues/#516-

      fields = oConvertUtils.getAllFields(parameter);
   } else {
      fields = oConvertUtils.getAllFields(parameter);
   }

   for (Field field : fields) {
      log.debug("------field.name------" + field.getName());
      try {
         if ("updateBy".equals(field.getName())) {
            //获取登录用户信息
            if (sysUser != null) {
               // 登录账号
               field.setAccessible(true);
               field.set(parameter, sysUser.getUsername());
               field.setAccessible(false);
            }
         }
         if ("updateTime".equals(field.getName())) {
            field.setAccessible(true);
            field.set(parameter, new Date());
            field.setAccessible(false);
         }
      } catch (Exception e) {
         e.printStackTrace();
      }
   }
}
```